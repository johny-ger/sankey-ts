(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))e(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&e(r)}).observe(document,{childList:!0,subtree:!0});function n(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function e(o){if(o.ep)return;o.ep=!0;const i=n(o);fetch(o.href,i)}})();function Y(s){const t=new Map,n=new Map;s.nodes.forEach(i=>{t.set(i.id,0),n.set(i.id,[])}),s.links.forEach(i=>{n.get(i.source).push(i.target),t.set(i.target,(t.get(i.target)||0)+1)});const e=[];t.forEach((i,r)=>i===0&&e.push(r));const o=new Map;for(e.forEach(i=>o.set(i,0));e.length;){const i=e.shift(),r=o.get(i)||0;for(const a of n.get(i))o.set(a,Math.max(o.get(a)||0,r+1)),t.set(a,(t.get(a)||0)-1),(t.get(a)||0)===0&&e.push(a)}return s.nodes.forEach(i=>{o.has(i.id)||o.set(i.id,0)}),o}function X(s,t){const n=Y(s),e=new Map;s.nodes.forEach(c=>{const p=n.get(c.id)||0;e.has(p)||e.set(p,[]),e.get(p).push(c)});const o=Array.from(e.keys()).sort((c,p)=>c-p),i=Math.max(1,o.length),r=t.width-2*t.padding,a=i>1?(r-(i-1)*t.colGap)/i:r,l=new Map,h=new Map;s.nodes.forEach(c=>h.set(c.id,0)),s.links.forEach(c=>{h.set(c.source,(h.get(c.source)||0)+c.value),h.set(c.target,Math.max(h.get(c.target)||0,0))});const u=12;for(const c of o){const p=e.get(c),d=p.map(f=>Math.max(f.height??h.get(f.id)*t.linkWidthScale,12)),w=d.reduce((f,S)=>f+S,0)+t.nodeGap*Math.max(0,p.length-1),L=t.height-2*t.padding,P=t.padding+Math.max(0,(L-w)/2),z=t.padding+c*(a+t.colGap)+Math.max(0,(a-u)/2);let I=P;p.forEach((f,S)=>{const F=f.width??u,N=d[S];l.set(f.id,{x:f.x??z,y:f.y??I,width:F,height:N}),I+=N+t.nodeGap})}return s.nodes.forEach(c=>{l.has(c.id)||l.set(c.id,{x:c.x??t.padding,y:c.y??t.padding,width:c.width??u,height:c.height??24})}),{nodes:l}}function A(s="id"){return`${s}_${Math.random().toString(36).slice(2,9)}`}function T(s,t,n){return Math.max(t,Math.min(n,s))}function y(s,t={}){const n=document.createElementNS("http://www.w3.org/2000/svg",s);for(const[e,o]of Object.entries(t))n.setAttribute(e,String(o));return n}class K{constructor(t,n,e={}){this.positions=new Map,this.vb={x:0,y:0,w:0,h:0},this.isPanning=!1,this.panStart={x:0,y:0},this.container=t,this.data={nodes:n.nodes.map(i=>({...i})),links:n.links.map(i=>({id:i.id??A("link"),...i}))},this.options={width:e.width??960,height:e.height??540,padding:e.padding??24,nodeGap:e.nodeGap??18,colGap:e.colGap??120,linkWidthScale:e.linkWidthScale??2,curvature:T(e.curvature??.5,0,1),defaultNodeColor:e.defaultNodeColor??"#4f46e5",defaultLinkColor:e.defaultLinkColor??"#94a3b8",draggable:e.draggable??!0,saveKey:e.saveKey??"sankey-layout"},this.container.innerHTML="",this.svg=y("svg",{class:"sankey"}),this.vb={x:0,y:0,w:this.options.width,h:this.options.height},this.updateViewBox();const o=y("g",{class:"sankey-bg"});this.bgRect=y("rect",{x:0,y:0,width:this.options.width,height:this.options.height}),this.bgRect.setAttribute("fill","transparent"),this.bgRect.setAttribute("pointer-events","all"),o.append(this.bgRect),this.gLinks=y("g",{class:"sankey-links"}),this.gNodes=y("g",{class:"sankey-nodes"}),this.svg.append(o,this.gLinks,this.gNodes),this.container.appendChild(this.svg),this.compute(),this.render(),this.wireResizeObserver(),this.wireZoomPan()}get storageKeyIndex(){return`${this.options.saveKey}::index`}storageKeyOf(t){return`${this.options.saveKey}::layout::${t}`}readIndex(){try{return JSON.parse(localStorage.getItem(this.storageKeyIndex)||"[]")||[]}catch{return[]}}writeIndex(t){localStorage.setItem(this.storageKeyIndex,JSON.stringify(Array.from(new Set(t))))}updateViewBox(){this.svg.setAttribute("viewBox",`${this.vb.x} ${this.vb.y} ${this.vb.w} ${this.vb.h}`),this.bgRect&&(this.bgRect.setAttribute("x",String(this.vb.x-0)),this.bgRect.setAttribute("y",String(this.vb.y-0)),this.bgRect.setAttribute("width",String(this.vb.w+0)),this.bgRect.setAttribute("height",String(this.vb.h+0)))}wireResizeObserver(){}resize(t,n){this.options.width=t,this.options.height=n,this.vb={x:0,y:0,w:t,h:n},this.updateViewBox()}setLinkWidthScale(t){this.options.linkWidthScale=Math.max(.1,t),this.compute(),this.render()}setNodeColor(t,n){const e=this.data.nodes.find(o=>o.id===t);e&&(e.color=n,this.renderNodes(),this.renderLinks())}setLinkColor(t,n){const e=this.data.links.find(o=>o.id===t);e&&(e.color=n,this.renderLinks())}setNodePosition(t,n,e){const o=this.positions.get(t);if(o){o.x=n,o.y=e;const i=this.data.nodes.find(r=>r.id===t);i.x=n,i.y=e,this.render()}}snapshot(){return{nodes:this.data.nodes.map(t=>({id:t.id,x:this.positions.get(t.id).x,y:this.positions.get(t.id).y,color:t.color})),options:{linkWidthScale:this.options.linkWidthScale}}}saveLayout(t=!0){const n=this.snapshot();return t&&localStorage.setItem(this.options.saveKey,JSON.stringify(n)),n}saveLayoutAs(t){const n=t.trim();if(!n)throw new Error("Имя сохранения не может быть пустым");const e=this.snapshot();localStorage.setItem(this.storageKeyOf(n),JSON.stringify(e));const o=this.readIndex();return o.includes(n)||o.push(n),this.writeIndex(o),e}listLayouts(){return this.readIndex().sort((t,n)=>t.localeCompare(n))}deleteLayout(t){const n=t.trim();localStorage.removeItem(this.storageKeyOf(n)),this.writeIndex(this.readIndex().filter(e=>e!==n))}loadLayout(t){const n=t??JSON.parse(localStorage.getItem(this.options.saveKey)||"null");n&&this.applySnapshot(n)}loadLayoutByName(t){const n=localStorage.getItem(this.storageKeyOf(t));if(!n)return;const e=JSON.parse(n);this.applySnapshot(e)}applySnapshot(t){const n=new Map(this.data.nodes.map(e=>[e.id,e]));t.nodes.forEach(e=>{const o=n.get(e.id);o&&(o.x=e.x,o.y=e.y,e.color&&(o.color=e.color))}),t.options?.linkWidthScale&&(this.options.linkWidthScale=t.options.linkWidthScale),this.compute(),this.render()}exportLayoutJSON(){return JSON.stringify(this.saveLayout(!1),null,2)}setData(t){this.data={nodes:t.nodes.map(n=>({...n})),links:t.links.map(n=>({id:n.id??A("link"),...n}))},this.compute(),this.render()}compute(){const{nodes:t}=X(this.data,{width:this.options.width,height:this.options.height,padding:this.options.padding,nodeGap:this.options.nodeGap,colGap:this.options.colGap,linkWidthScale:this.options.linkWidthScale});this.positions=t}render(){this.gLinks.innerHTML="",this.gNodes.innerHTML="",this.renderLinks(),this.renderNodes()}linkPath(t,n){const e=t.x+t.width,o=t.y+t.height/2,i=n.x,r=n.y+n.height/2,a=i-e,l=this.options.curvature,h=e+a*l,u=o,c=i-a*l;return`M ${e} ${o} C ${h} ${u}, ${c} ${r}, ${i} ${r}`}renderLinks(){const t=[...this.data.links].sort((n,e)=>e.value-n.value);for(const n of t){const e=this.positions.get(n.source),o=this.positions.get(n.target);if(!e||!o)continue;const i=y("path",{class:"sankey-link",d:this.linkPath(e,o)});i.setAttribute("fill","none"),i.setAttribute("stroke",n.color||this.data.nodes.find(r=>r.id===n.source)?.color||this.options.defaultLinkColor),i.setAttribute("stroke-width",String(Math.max(1,n.value*this.options.linkWidthScale))),i.setAttribute("stroke-linecap","round"),i.setAttribute("opacity","0.9"),i.setAttribute("data-id",n.id),i.addEventListener("mouseenter",()=>i.setAttribute("opacity","1")),i.addEventListener("mouseleave",()=>i.setAttribute("opacity","0.9")),i.addEventListener("dblclick",()=>this.pickColor(n.color||this.options.defaultLinkColor,r=>this.setLinkColor(n.id,r))),this.gLinks.appendChild(i)}}renderNodes(){for(const t of this.data.nodes){const n=this.positions.get(t.id),e=y("g",{class:"sankey-node"});e.setAttribute("data-id",t.id);const o=y("rect",{x:n.x,y:n.y,rx:6,ry:6,width:n.width,height:n.height});o.setAttribute("fill",t.color||this.options.defaultNodeColor),o.setAttribute("filter","drop-shadow(0 1px 1px rgba(0,0,0,0.25))");const i=y("text",{x:n.x+n.width+8,y:n.y+n.height/2});i.setAttribute("dominant-baseline","middle"),i.setAttribute("class","sankey-label"),i.textContent=t.label??t.id,e.append(o,i),this.gNodes.appendChild(e),this.options.draggable&&this.enableDrag(e,t.id),e.addEventListener("dblclick",()=>this.pickColor(t.color||this.options.defaultNodeColor,r=>this.setNodeColor(t.id,r)))}}pickColor(t,n){const e=document.createElement("input");e.type="color",e.value=t,e.style.position="fixed",e.style.left="-9999px",document.body.appendChild(e),e.click(),e.oninput=()=>n(e.value),e.onchange=()=>{n(e.value),document.body.removeChild(e)},e.onblur=()=>{document.body.contains(e)&&document.body.removeChild(e)}}enableDrag(t,n){let e=!1,o=0,i=0;const r=h=>{if(!(h.target instanceof SVGElement))return;e=!0;const u=this.positions.get(n),c=this.clientToSvg(h.clientX,h.clientY);o=c.x-u.x,i=c.y-u.y,t.classList.add("dragging"),window.addEventListener("mousemove",a),window.addEventListener("mouseup",l)},a=h=>{if(!e)return;const u=this.clientToSvg(h.clientX,h.clientY),c=u.x-o,p=u.y-i;this.setNodePosition(n,c,p)},l=()=>{e&&(e=!1,t.classList.remove("dragging"),window.removeEventListener("mousemove",a),window.removeEventListener("mouseup",l),this.saveLayout())};t.addEventListener("mousedown",r)}clientToSvg(t,n){const e=this.svg.createSVGPoint();e.x=t,e.y=n;const o=this.svg.getScreenCTM();if(!o)return{x:t,y:n};const i=e.matrixTransform(o.inverse());return{x:i.x,y:i.y}}fit(){this.vb={x:0,y:0,w:this.options.width,h:this.options.height},this.updateViewBox()}zoomIn(t=1.2,n){this.zoomAt(t,n)}zoomOut(t=1/1.2,n){this.zoomAt(t,n)}zoomAt(t,n){const e=this.options.width/8,o=this.options.width*4,i=n?this.clientToSvg(n.clientX,n.clientY):{x:this.vb.x+this.vb.w/2,y:this.vb.y+this.vb.h/2},r=Math.min(o,Math.max(e,this.vb.w/t)),a=r*(this.vb.h/this.vb.w),l=(i.x-this.vb.x)/this.vb.w,h=(i.y-this.vb.y)/this.vb.h,u=i.x-l*r,c=i.y-h*a;this.vb={x:u,y:c,w:r,h:a},this.updateViewBox()}wireZoomPan(){this.svg.addEventListener("wheel",d=>{d.preventDefault(),d.deltaY>0?this.zoomOut(1/.9,{clientX:d.clientX,clientY:d.clientY}):this.zoomIn(.9,{clientX:d.clientX,clientY:d.clientY})},{passive:!1});const t=d=>!!(d&&d instanceof Element&&!d.closest(".sankey-node")&&!d.closest(".sankey-link"));let n=1,e=1,o=0,i=0,r=0,a=0,l=null;const h=()=>{l==null&&(l=requestAnimationFrame(()=>{l=null,(r!==0||a!==0)&&(this.vb.x-=r,this.vb.y-=a,r=a=0,this.updateViewBox())}))},u=d=>{if(!this.isPanning)return;const w=(d.clientX-o)*n,L=(d.clientY-i)*e;o=d.clientX,i=d.clientY,r+=w,a+=L,h()},c=()=>{this.isPanning&&(this.isPanning=!1,this.container.style.cursor="",this.svg.releasePointerCapture(p),window.removeEventListener("pointermove",u),window.removeEventListener("pointerup",c),window.removeEventListener("pointercancel",c))};let p=-1;this.svg.addEventListener("pointerdown",d=>{if(d.button!==0||!t(d.target))return;const w=this.svg.getBoundingClientRect();n=this.vb.w/Math.max(1,w.width),e=this.vb.h/Math.max(1,w.height),this.isPanning=!0,p=d.pointerId,o=d.clientX,i=d.clientY,r=a=0,this.container.style.cursor="grabbing",this.svg.setPointerCapture(p),window.addEventListener("pointermove",u,{passive:!0}),window.addEventListener("pointerup",c,{passive:!0}),window.addEventListener("pointercancel",c,{passive:!0})})}}function D(s){const t=document.createElement("input");t.type="file",t.accept=".json,application/json",t.style.display="none",document.body.appendChild(t),t.addEventListener("change",()=>{const n=t.files?.[0];if(!n)return;const e=new FileReader;e.onload=o=>{try{const i=JSON.parse(o.target?.result);s.loadLayout(i),m("Раскладка успешно загружена из JSON!")}catch(i){m("Ошибка загрузки JSON: "+i.message)}},e.readAsText(n),document.body.removeChild(t)}),t.click()}const R={nodes:[{id:"A",label:"Источники A",color:"#22c55e"},{id:"B",label:"Источники B",color:"#06b6d4"},{id:"C",label:"Обработка C",color:"#f59e0b"},{id:"D",label:"Обработка D",color:"#ef4444"},{id:"E",label:"Хранилище E",color:"#8b5cf6"},{id:"F",label:"Потребители F",color:"#6366f1"}],links:[{source:"A",target:"C",value:10},{source:"B",target:"C",value:6},{source:"A",target:"D",value:4,color:"#16a34a"},{source:"C",target:"E",value:12},{source:"D",target:"E",value:4},{source:"E",target:"F",value:14}]},b=document.getElementById("app"),g=new K(b,R,{width:b.clientWidth,height:b.clientHeight,linkWidthScale:2,draggable:!0,saveKey:"sankey-ts-demo"}),M=document.getElementById("btn-import-json");M&&M.addEventListener("click",()=>D(g));const v=document.getElementById("scale"),G=document.getElementById("scaleVal"),B=document.getElementById("layoutName"),k=document.getElementById("layoutSelect"),V=document.getElementById("saveAsBtn"),J=document.getElementById("loadSelectedBtn"),H=document.getElementById("deleteSelectedBtn"),j=document.getElementById("linksFile"),q=document.getElementById("nodesFile"),U=document.getElementById("buildBtn"),Z=document.getElementById("zoomInBtn"),_=document.getElementById("zoomOutBtn"),Q=document.getElementById("fitBtn"),tt=document.getElementById("helpBtn"),x=document.getElementById("helpModal"),et=document.getElementById("helpCloseBtn"),nt=document.getElementById("toasts");v.addEventListener("input",()=>{g.setLinkWidthScale(parseFloat(v.value)),G.textContent=`${parseFloat(v.value).toFixed(1)}x`});V.onclick=()=>{const s=(B.value||"").trim();if(!s){m("Введите имя варианта перед сохранением"),B.focus();return}g.saveLayoutAs(s),C(s),m(`Сохранено: «${s}»`)};J.onclick=()=>{const s=k.value;if(!s){m("Выберите вариант для загрузки");return}g.loadLayoutByName(s),v.value=String(g.options?.linkWidthScale??v.value),v.dispatchEvent(new Event("input")),m(`Загружено: «${s}»`)};H.onclick=()=>{const s=k.value;if(!s){m("Выберите вариант для удаления");return}confirm(`Удалить сохранение "${s}"?`)&&(g.deleteLayout(s),C(""),m(`Удалено: «${s}»`))};document.getElementById("resetBtn").onclick=()=>{location.reload()};document.getElementById("exportBtn").onclick=()=>{const s=g.exportLayoutJSON();document.getElementById("exportBox").value=s,m("Экспортировано в JSON (см. панель справа)")};U.onclick=async()=>{const s=await O(j.files?.[0]).catch(()=>null);if(!s){m("Пожалуйста, выберите файл links.csv");return}const t=await O(q.files?.[0]).catch(()=>null);try{const n=it(s),o={nodes:t?ot(t):st(n),links:n};g.setData(o),v.dispatchEvent(new Event("input")),m("Диаграмма построена из CSV")}catch(n){m(`Ошибка: ${n?.message||n}`)}};function C(s){const t=g.listLayouts();k.innerHTML='<option value="">— сохранённые варианты —</option>';for(const n of t){const e=document.createElement("option");e.value=n,e.textContent=n,s&&n===s&&(e.selected=!0),k.appendChild(e)}}C();Z.onclick=s=>{g.zoomIn(1.2,{clientX:s.clientX,clientY:s.clientY})};_.onclick=s=>{g.zoomOut(1/1.2,{clientX:s.clientX,clientY:s.clientY})};Q.onclick=()=>{g.fit()};tt.onclick=()=>x.showModal();et.onclick=()=>x.close();function m(s,t=2200){const n=document.createElement("div");n.className="toast",n.textContent=s,nt.appendChild(n),setTimeout(()=>n.remove(),t)}window.addEventListener("resize",()=>{g.resize(b.clientWidth,b.clientHeight),g.compute?.(),g.render()});window.addEventListener("keydown",s=>{s.key==="?"&&(x.open?x.close():x.showModal()),(s.key==="+"||s.key==="="&&s.shiftKey)&&g.zoomIn(1.2),(s.key==="-"||s.key==="_")&&g.zoomOut(1/1.2),s.key.toLowerCase()==="f"&&g.fit(),s.key.toLowerCase()==="s"&&B.focus(),s.key.toLowerCase()==="l"&&k.focus()});function O(s){return new Promise((t,n)=>{if(!s)return n(new Error("no file"));const e=new FileReader;e.onload=()=>t(String(e.result||"")),e.onerror=n,e.readAsText(s)})}function W(s){const t=[];let n=[],e="",o=!1;const i=()=>{n.push(e),e=""},r=()=>{t.push(n.slice()),n=[]};for(let a=0;a<s.length;a++){const l=s[a];o?l==='"'?s[a+1]==='"'?(e+='"',a++):o=!1:e+=l:l==='"'?o=!0:l===","?i():l===`
`||l==="\r"?(l==="\r"&&s[a+1]===`
`&&a++,i(),r()):e+=l}return i(),(n.length>1||n.length===1&&n[0]!=="")&&r(),t.filter(a=>a.some(l=>l.trim()!==""))}function $(s){const t={};return s.forEach((n,e)=>t[n.trim().toLowerCase()]=e),t}function it(s){const t=W(s);if(t.length===0)throw new Error("links.csv пустой");const n=t[0].map(r=>r.trim()),e=$(n),o=["source","target","value"];for(const r of o)if(!(r in e))throw new Error(`links.csv: нет колонки "${r}"`);const i=[];for(let r=1;r<t.length;r++){const a=t[r];if(!a.length)continue;const l=a[e.source]?.trim(),h=a[e.target]?.trim(),u=Number(a[e.value]);if(!l||!h||!Number.isFinite(u))continue;const c=e.color!==void 0&&a[e.color]?.trim()||void 0;i.push({source:l,target:h,value:u,color:c})}if(!i.length)throw new Error("links.csv: не найдено валидных строк");return i}function ot(s){const t=W(s);if(t.length===0)throw new Error("nodes.csv пустой");const n=t[0].map(i=>i.trim()),e=$(n);if(!("id"in e))throw new Error('nodes.csv: нет колонки "id"');const o=[];for(let i=1;i<t.length;i++){const r=t[i];if(!r.length)continue;const a=r[e.id]?.trim();if(!a)continue;const l=e.label!==void 0&&(r[e.label]||"").trim()||void 0,h=e.color!==void 0&&(r[e.color]||"").trim()||void 0,u=e.x!==void 0?E(r[e.x]):void 0,c=e.y!==void 0?E(r[e.y]):void 0,p=e.width!==void 0?E(r[e.width]):void 0,d=e.height!==void 0?E(r[e.height]):void 0;o.push({id:a,label:l,color:h,x:u,y:c,width:p,height:d})}if(!o.length)throw new Error("nodes.csv: не найдено валидных строк");return o}function st(s){const t=new Set;for(const n of s)t.add(n.source),t.add(n.target);return Array.from(t).map(n=>({id:n,label:n}))}function E(s){if(s==null||String(s).trim()==="")return;const t=Number(s);return Number.isFinite(t)?t:void 0}
