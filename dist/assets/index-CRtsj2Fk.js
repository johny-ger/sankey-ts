(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function e(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(i){if(i.ep)return;i.ep=!0;const s=e(i);fetch(i.href,s)}})();function P(o){const t=new Map,e=new Map;o.nodes.forEach(s=>{t.set(s.id,0),e.set(s.id,[])}),o.links.forEach(s=>{e.get(s.source).push(s.target),t.set(s.target,(t.get(s.target)||0)+1)});const n=[];t.forEach((s,r)=>s===0&&n.push(r));const i=new Map;for(n.forEach(s=>i.set(s,0));n.length;){const s=n.shift(),r=i.get(s)||0;for(const c of e.get(s))i.set(c,Math.max(i.get(c)||0,r+1)),t.set(c,(t.get(c)||0)-1),(t.get(c)||0)===0&&n.push(c)}return o.nodes.forEach(s=>{i.has(s.id)||i.set(s.id,0)}),i}function z(o,t){const e=P(o),n=new Map;o.nodes.forEach(a=>{const g=e.get(a.id)||0;n.has(g)||n.set(g,[]),n.get(g).push(a)});const i=Array.from(n.keys()).sort((a,g)=>a-g),s=Math.max(1,i.length),r=t.width-2*t.padding,c=s>1?(r-(s-1)*t.colGap)/s:r,l=new Map,d=new Map;o.nodes.forEach(a=>d.set(a.id,0)),o.links.forEach(a=>{d.set(a.source,(d.get(a.source)||0)+a.value),d.set(a.target,Math.max(d.get(a.target)||0,0))});const h=12;for(const a of i){const g=n.get(a),v=g.map(m=>Math.max(m.height??d.get(m.id)*t.linkWidthScale,12)),L=v.reduce((m,N)=>m+N,0)+t.nodeGap*Math.max(0,g.length-1),k=t.height-2*t.padding,u=t.padding+Math.max(0,(k-L)/2),w=t.padding+a*(c+t.colGap)+Math.max(0,(c-h)/2);let B=u;g.forEach((m,N)=>{const K=m.width??h,$=v[N];l.set(m.id,{x:m.x??w,y:m.y??B,width:K,height:$}),B+=$+t.nodeGap})}return o.nodes.forEach(a=>{l.has(a.id)||l.set(a.id,{x:a.x??t.padding,y:a.y??t.padding,width:a.width??h,height:a.height??24})}),{nodes:l}}function O(o="id"){return`${o}_${Math.random().toString(36).slice(2,9)}`}function D(o,t,e){return Math.max(t,Math.min(e,o))}function y(o,t={}){const e=document.createElementNS("http://www.w3.org/2000/svg",o);for(const[n,i]of Object.entries(t))e.setAttribute(n,String(i));return e}function X(o,t,e){const n=o.x+o.width,i=o.y+o.height/2,s=t.x,r=t.y+t.height/2,c=s-n,l=Math.max(0,Math.min(1,e)),d=n+c*l,h=i,a=s-c*l;return`M ${n} ${i} C ${d} ${h}, ${a} ${r}, ${s} ${r}`}function W(o,t){const e=document.createElement("input");e.type="color",e.value=o,e.style.position="fixed",e.style.left="-9999px",document.body.appendChild(e),e.click(),e.oninput=()=>t(e.value),e.onchange=()=>{t(e.value),n()},e.onblur=()=>n();function n(){document.body.contains(e)&&document.body.removeChild(e)}}function G(o,t,e){let n=!1,i=0,s=0;const r=d=>{if(!(d.target instanceof SVGElement))return;n=!0;const h=o.clientToSvg(d.clientX,d.clientY),a=t.querySelector("rect"),g=a?Number(a.getAttribute("x")||0):0,v=a?Number(a.getAttribute("y")||0):0;i=h.x-g,s=h.y-v,t.classList.add("dragging"),window.addEventListener("mousemove",c),window.addEventListener("mouseup",l)},c=d=>{if(!n)return;const h=o.clientToSvg(d.clientX,d.clientY);o.setNodePosition(e,h.x-i,h.y-s)},l=()=>{n&&(n=!1,t.classList.remove("dragging"),window.removeEventListener("mousemove",c),window.removeEventListener("mouseup",l),o.saveLayout?.())};t.addEventListener("mousedown",r)}function V(o){const{svg:t,container:e}=o;let n=!1,i=1,s=1,r=0,c=0,l=0,d=0,h=null,a=-1;const g=u=>!!(u&&u instanceof Element&&!u.closest(".sankey-node")&&!u.closest(".sankey-link")),v=()=>{h==null&&(h=requestAnimationFrame(()=>{h=null,(l||d)&&(o.vb.x-=l,o.vb.y-=d,l=d=0,o.updateViewBox())}))};t.addEventListener("wheel",u=>{u.preventDefault();const w=u.deltaY>0?1/.9:.9;I(o,w,{clientX:u.clientX,clientY:u.clientY})},{passive:!1});const L=u=>{if(!n)return;const w=(u.clientX-r)*i,B=(u.clientY-c)*s;r=u.clientX,c=u.clientY,l+=w,d+=B,v()},k=()=>{if(n){n=!1,e.style.cursor="";try{t.releasePointerCapture(a)}catch{}window.removeEventListener("pointermove",L),window.removeEventListener("pointerup",k),window.removeEventListener("pointercancel",k)}};t.addEventListener("pointerdown",u=>{if(u.button!==0||!g(u.target))return;const w=t.getBoundingClientRect();i=o.vb.w/Math.max(1,w.width),s=o.vb.h/Math.max(1,w.height),n=!0,a=u.pointerId,r=u.clientX,c=u.clientY,l=d=0,e.style.cursor="grabbing";try{t.setPointerCapture(a)}catch{}window.addEventListener("pointermove",L,{passive:!0}),window.addEventListener("pointerup",k,{passive:!0}),window.addEventListener("pointercancel",k,{passive:!0})})}function I(o,t,e){const n=o.vb.w/8,i=o.vb.w*4,s=e?o.clientToSvg(e.clientX,e.clientY):{x:o.vb.x+o.vb.w/2,y:o.vb.y+o.vb.h/2},r=Math.min(i,Math.max(n,o.vb.w/t)),c=r*(o.vb.h/o.vb.w),l=(s.x-o.vb.x)/o.vb.w,d=(s.y-o.vb.y)/o.vb.h;o.vb={x:s.x-l*r,y:s.y-d*c,w:r,h:c},o.updateViewBox()}class R{constructor(t,e,n={}){this.positions=new Map,this.vb={x:0,y:0,w:0,h:0},this.container=t,this.data={nodes:e.nodes.map(s=>({...s})),links:e.links.map(s=>({id:s.id??O("link"),...s}))},this.options={width:n.width??960,height:n.height??540,padding:n.padding??24,nodeGap:n.nodeGap??18,colGap:n.colGap??120,linkWidthScale:n.linkWidthScale??2,curvature:D(n.curvature??.5,0,1),defaultNodeColor:n.defaultNodeColor??"#4f46e5",defaultLinkColor:n.defaultLinkColor??"#94a3b8",draggable:n.draggable??!0,saveKey:n.saveKey??"sankey-layout"},this.container.innerHTML="",this.svg=y("svg",{class:"sankey"}),this.vb={x:0,y:0,w:this.options.width,h:this.options.height},this.updateViewBox();const i=y("g",{class:"sankey-bg"});this.bgRect=y("rect",{x:0,y:0,width:this.options.width,height:this.options.height}),this.bgRect.setAttribute("fill","transparent"),this.bgRect.setAttribute("pointer-events","all"),i.append(this.bgRect),this.gLinks=y("g",{class:"sankey-links"}),this.gNodes=y("g",{class:"sankey-nodes"}),this.svg.append(i,this.gLinks,this.gNodes),this.container.appendChild(this.svg),this.compute(),this.render(),V(this)}updateViewBox(){this.svg.setAttribute("viewBox",`${this.vb.x} ${this.vb.y} ${this.vb.w} ${this.vb.h}`),this.bgRect&&(this.bgRect.setAttribute("x",String(this.vb.x)),this.bgRect.setAttribute("y",String(this.vb.y)),this.bgRect.setAttribute("width",String(this.vb.w)),this.bgRect.setAttribute("height",String(this.vb.h)))}resize(t,e){this.options.width=t,this.options.height=e,this.vb={x:0,y:0,w:t,h:e},this.updateViewBox()}setLinkWidthScale(t){this.options.linkWidthScale=Math.max(.1,t),this.compute(),this.render()}setNodeColor(t,e){const n=this.data.nodes.find(i=>i.id===t);n&&(n.color=e,this.renderNodes(),this.renderLinks())}setLinkColor(t,e){const n=this.data.links.find(i=>i.id===t);n&&(n.color=e,this.renderLinks())}setNodePosition(t,e,n){const i=this.positions.get(t);if(i){i.x=e,i.y=n;const s=this.data.nodes.find(r=>r.id===t);s.x=e,s.y=n,this.render()}}snapshot(){const t=this.data.nodes.map(n=>{const i=this.positions.get(n.id);return{id:n.id,x:i.x,y:i.y,color:n.color,label:n.label,width:i.width,height:i.height}}),e=this.data.links.map(n=>({id:n.id,source:n.source,target:n.target,value:n.value,color:n.color}));return{nodes:t,links:e,options:{linkWidthScale:this.options.linkWidthScale}}}saveLayout(t=!0){const e=this.snapshot();return t&&localStorage.setItem(this.options.saveKey,JSON.stringify(e)),e}saveLayoutAs(t){const e=t.trim();if(!e)throw new Error("Имя сохранения не может быть пустым");const n=this.snapshot();localStorage.setItem(`${this.options.saveKey}::layout::${e}`,JSON.stringify(n));const i=`${this.options.saveKey}::index`,s=JSON.parse(localStorage.getItem(i)||"[]");return s.includes(e)||s.push(e),localStorage.setItem(i,JSON.stringify(s)),n}listLayouts(){const t=`${this.options.saveKey}::index`;return JSON.parse(localStorage.getItem(t)||"[]").sort((n,i)=>n.localeCompare(i))}deleteLayout(t){localStorage.removeItem(`${this.options.saveKey}::layout::${t}`);const e=`${this.options.saveKey}::index`,n=JSON.parse(localStorage.getItem(e)||"[]").filter(i=>i!==t);localStorage.setItem(e,JSON.stringify(n))}loadLayout(t){const e=t??JSON.parse(localStorage.getItem(this.options.saveKey)||"null");e&&this.applySnapshot(e)}loadLayoutByName(t){const e=localStorage.getItem(`${this.options.saveKey}::layout::${t}`);e&&this.applySnapshot(JSON.parse(e))}applySnapshot(t){if(t.links&&Array.isArray(t.links)){const n=t.nodes.map(s=>({...s})),i=t.links.map(s=>({...s}));this.setData({nodes:n,links:i}),t.options?.linkWidthScale&&(this.options.linkWidthScale=t.options.linkWidthScale),this.compute(),this.render();return}const e=new Map(this.data.nodes.map(n=>[n.id,n]));t.nodes.forEach(n=>{const i=e.get(n.id);i&&(i.x=n.x,i.y=n.y,i.color=n.color??i.color,i.label=n.label??i.label)}),t.options?.linkWidthScale&&(this.options.linkWidthScale=t.options.linkWidthScale),this.compute(),this.render()}exportLayoutJSON(){return JSON.stringify(this.saveLayout(!1),null,2)}setData(t){this.data={nodes:t.nodes.map(e=>({...e})),links:t.links.map(e=>({id:e.id??O("link"),...e}))},this.compute(),this.render()}compute(){const{nodes:t}=z(this.data,{width:this.options.width,height:this.options.height,padding:this.options.padding,nodeGap:this.options.nodeGap,colGap:this.options.colGap,linkWidthScale:this.options.linkWidthScale});this.positions=t}render(){this.gLinks.innerHTML="",this.gNodes.innerHTML="",this.renderLinks(),this.renderNodes()}renderLinks(){const t=[...this.data.links].sort((e,n)=>n.value-e.value);for(const e of t){const n=this.positions.get(e.source),i=this.positions.get(e.target);if(!n||!i)continue;const s=X(n,i,this.options.curvature),r=y("path",{class:"sankey-link",d:s});r.setAttribute("fill","none"),r.setAttribute("stroke",e.color||this.data.nodes.find(c=>c.id===e.source)?.color||this.options.defaultLinkColor),r.setAttribute("stroke-width",String(Math.max(1,e.value*this.options.linkWidthScale))),r.setAttribute("stroke-linecap","round"),r.setAttribute("opacity","0.9"),r.setAttribute("data-id",e.id),r.addEventListener("mouseenter",()=>r.setAttribute("opacity","1")),r.addEventListener("mouseleave",()=>r.setAttribute("opacity","0.9")),r.addEventListener("dblclick",()=>W(e.color||this.options.defaultLinkColor,c=>this.setLinkColor(e.id,c))),this.gLinks.appendChild(r)}}renderNodes(){for(const t of this.data.nodes){const e=this.positions.get(t.id),n=y("g",{class:"sankey-node"});n.setAttribute("data-id",t.id);const i=y("rect",{x:e.x,y:e.y,rx:6,ry:6,width:e.width,height:e.height});i.setAttribute("fill",t.color||this.options.defaultNodeColor),i.setAttribute("filter","drop-shadow(0 1px 1px rgba(0,0,0,0.25))");const s=y("text",{x:e.x+e.width+8,y:e.y+e.height/2});s.setAttribute("dominant-baseline","middle"),s.setAttribute("class","sankey-label"),s.textContent=t.label??t.id,n.append(i,s),this.gNodes.appendChild(n),this.options.draggable&&G(this,n,t.id),n.addEventListener("dblclick",()=>W(t.color||this.options.defaultNodeColor,r=>this.setNodeColor(t.id,r)))}}clientToSvg(t,e){const n=this.svg.createSVGPoint();n.x=t,n.y=e;const i=this.svg.getScreenCTM();if(!i)return{x:t,y:e};const s=n.matrixTransform(i.inverse());return{x:s.x,y:s.y}}fit(){this.vb={x:0,y:0,w:this.options.width,h:this.options.height},this.updateViewBox()}zoomIn(t=1.2,e){I(this,t,e)}zoomOut(t=1/1.2,e){I(this,t,e)}}function H(o){const t=document.createElement("input");t.type="file",t.accept=".json,application/json",t.style.display="none",document.body.appendChild(t),t.addEventListener("change",()=>{const e=t.files?.[0];if(!e)return;const n=new FileReader;n.onload=i=>{try{const s=JSON.parse(i.target?.result);o.loadLayout(s),f("Раскладка успешно загружена из JSON!")}catch(s){f("Ошибка загрузки JSON: "+s.message)}},n.readAsText(e),document.body.removeChild(t)}),t.click()}const j={nodes:[{id:"A",label:"Источники A",color:"#22c55e"},{id:"B",label:"Источники B",color:"#06b6d4"},{id:"C",label:"Обработка C",color:"#f59e0b"},{id:"D",label:"Обработка D",color:"#ef4444"},{id:"E",label:"Хранилище E",color:"#8b5cf6"},{id:"F",label:"Потребители F",color:"#6366f1"}],links:[{source:"A",target:"C",value:10},{source:"B",target:"C",value:6},{source:"A",target:"D",value:4,color:"#16a34a"},{source:"C",target:"E",value:12},{source:"D",target:"E",value:4},{source:"E",target:"F",value:14}]},x=document.getElementById("app"),p=new R(x,j,{width:x.clientWidth,height:x.clientHeight,linkWidthScale:2,draggable:!0,saveKey:"sankey-ts-demo"}),F=document.getElementById("btn-import-json");F&&F.addEventListener("click",()=>H(p));const b=document.getElementById("scale"),q=document.getElementById("scaleVal"),A=document.getElementById("layoutName"),E=document.getElementById("layoutSelect"),U=document.getElementById("saveAsBtn"),_=document.getElementById("loadSelectedBtn"),Q=document.getElementById("deleteSelectedBtn"),Z=document.getElementById("linksFile"),tt=document.getElementById("nodesFile"),et=document.getElementById("buildBtn"),nt=document.getElementById("zoomInBtn"),ot=document.getElementById("zoomOutBtn"),it=document.getElementById("fitBtn"),st=document.getElementById("helpBtn"),S=document.getElementById("helpModal"),rt=document.getElementById("helpCloseBtn"),ct=document.getElementById("toasts");b.addEventListener("input",()=>{p.setLinkWidthScale(parseFloat(b.value)),q.textContent=`${parseFloat(b.value).toFixed(1)}x`});U.onclick=()=>{const o=(A.value||"").trim();if(!o){f("Введите имя варианта перед сохранением"),A.focus();return}p.saveLayoutAs(o),M(o),f(`Сохранено: «${o}»`)};_.onclick=()=>{const o=E.value;if(!o){f("Выберите вариант для загрузки");return}p.loadLayoutByName(o),b.value=String(p.options?.linkWidthScale??b.value),b.dispatchEvent(new Event("input")),f(`Загружено: «${o}»`)};Q.onclick=()=>{const o=E.value;if(!o){f("Выберите вариант для удаления");return}confirm(`Удалить сохранение "${o}"?`)&&(p.deleteLayout(o),M(""),f(`Удалено: «${o}»`))};document.getElementById("resetBtn").onclick=()=>{location.reload()};document.getElementById("exportBtn").onclick=()=>{const o=p.exportLayoutJSON();document.getElementById("exportBox").value=o,f("Экспортировано в JSON (см. панель справа)")};et.onclick=async()=>{const o=await T(Z.files?.[0]).catch(()=>null);if(!o){f("Пожалуйста, выберите файл links.csv");return}const t=await T(tt.files?.[0]).catch(()=>null);try{const e=at(o),i={nodes:t?lt(t):dt(e),links:e};p.setData(i),b.dispatchEvent(new Event("input")),f("Диаграмма построена из CSV")}catch(e){f(`Ошибка: ${e?.message||e}`)}};function M(o){const t=p.listLayouts();E.innerHTML='<option value="">— сохранённые варианты —</option>';for(const e of t){const n=document.createElement("option");n.value=e,n.textContent=e,o&&e===o&&(n.selected=!0),E.appendChild(n)}}M();nt.onclick=o=>{p.zoomIn(1.2,{clientX:o.clientX,clientY:o.clientY})};ot.onclick=o=>{p.zoomOut(1/1.2,{clientX:o.clientX,clientY:o.clientY})};it.onclick=()=>{p.fit()};st.onclick=()=>S.showModal();rt.onclick=()=>S.close();function f(o,t=2200){const e=document.createElement("div");e.className="toast",e.textContent=o,ct.appendChild(e),setTimeout(()=>e.remove(),t)}window.addEventListener("resize",()=>{p.resize(x.clientWidth,x.clientHeight),p.compute?.(),p.render()});window.addEventListener("keydown",o=>{o.key==="?"&&(S.open?S.close():S.showModal()),(o.key==="+"||o.key==="="&&o.shiftKey)&&p.zoomIn(1.2),(o.key==="-"||o.key==="_")&&p.zoomOut(1/1.2),o.key.toLowerCase()==="f"&&p.fit(),o.key.toLowerCase()==="s"&&A.focus(),o.key.toLowerCase()==="l"&&E.focus()});function T(o){return new Promise((t,e)=>{if(!o)return e(new Error("no file"));const n=new FileReader;n.onload=()=>t(String(n.result||"")),n.onerror=e,n.readAsText(o)})}function Y(o){const t=[];let e=[],n="",i=!1;const s=()=>{e.push(n),n=""},r=()=>{t.push(e.slice()),e=[]};for(let c=0;c<o.length;c++){const l=o[c];i?l==='"'?o[c+1]==='"'?(n+='"',c++):i=!1:n+=l:l==='"'?i=!0:l===","?s():l===`
`||l==="\r"?(l==="\r"&&o[c+1]===`
`&&c++,s(),r()):n+=l}return s(),(e.length>1||e.length===1&&e[0]!=="")&&r(),t.filter(c=>c.some(l=>l.trim()!==""))}function J(o){const t={};return o.forEach((e,n)=>t[e.trim().toLowerCase()]=n),t}function at(o){const t=Y(o);if(t.length===0)throw new Error("links.csv пустой");const e=t[0].map(r=>r.trim()),n=J(e),i=["source","target","value"];for(const r of i)if(!(r in n))throw new Error(`links.csv: нет колонки "${r}"`);const s=[];for(let r=1;r<t.length;r++){const c=t[r];if(!c.length)continue;const l=c[n.source]?.trim(),d=c[n.target]?.trim(),h=Number(c[n.value]);if(!l||!d||!Number.isFinite(h))continue;const a=n.color!==void 0&&c[n.color]?.trim()||void 0;s.push({source:l,target:d,value:h,color:a})}if(!s.length)throw new Error("links.csv: не найдено валидных строк");return s}function lt(o){const t=Y(o);if(t.length===0)throw new Error("nodes.csv пустой");const e=t[0].map(s=>s.trim()),n=J(e);if(!("id"in n))throw new Error('nodes.csv: нет колонки "id"');const i=[];for(let s=1;s<t.length;s++){const r=t[s];if(!r.length)continue;const c=r[n.id]?.trim();if(!c)continue;const l=n.label!==void 0&&(r[n.label]||"").trim()||void 0,d=n.color!==void 0&&(r[n.color]||"").trim()||void 0,h=n.x!==void 0?C(r[n.x]):void 0,a=n.y!==void 0?C(r[n.y]):void 0,g=n.width!==void 0?C(r[n.width]):void 0,v=n.height!==void 0?C(r[n.height]):void 0;i.push({id:c,label:l,color:d,x:h,y:a,width:g,height:v})}if(!i.length)throw new Error("nodes.csv: не найдено валидных строк");return i}function dt(o){const t=new Set;for(const e of o)t.add(e.source),t.add(e.target);return Array.from(t).map(e=>({id:e,label:e}))}function C(o){if(o==null||String(o).trim()==="")return;const t=Number(o);return Number.isFinite(t)?t:void 0}
